module.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(e,t){e.exports=require("events")},function(e,t,n){"use strict";t.__esModule=!0,t.getRoomAccessFromToken=function(e){var t=e.split(":")[2],n=r.Base64.decode(t);return console.log(n),JSON.parse(n)},t.timeout=function(e){void 0===e&&(e=1e3);return new Promise(function(t){setTimeout(function(){t()},e)})},t.rpcid=t.diff=void 0;var r=n(7),s=n(3);t.diff=function(e,t,n){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=s.identity);var r={add:[],remove:[]};if(0===e.length)return r.add=t,r;if(0===t.length)return r.remove=e,r;var o=e.map(n),i=t.map(n);return o.forEach(function(t,n){-1===i.indexOf(t)&&r.remove.push(e[n])}),i.forEach(function(e,n){-1===o.indexOf(e)&&r.add.push(t[n])}),r};t.rpcid=function(){return Math.random().toString(36).substring(7)}},function(e,t,n){"use strict";t.__esModule=!0,t.version=void 0;t.version="1.0.0-beta.0"},function(e,t,n){"use strict";t.__esModule=!0,t.find=t.propNotEq=t.prop=t.identity=void 0;t.identity=function(e){return e};t.prop=function(e){return function(t){return t[e]}};t.propNotEq=function(e,t){return function(n){return n[e]!==t}};t.find=function(e,t){return e&&0!==e.length?e.find(t):null}},function(e,t,n){"use strict";t.__esModule=!0;var r=i(n(5));t.RoomSession=r.default;var s=i(n(1));t.util=s.default;var o=n(2);function i(e){return e&&e.__esModule?e:{default:e}}t.version=o.version,console.log("QNRTC_Version: ",o.version)},function(e,t,n){"use strict";t.__esModule=!0,t.default=void 0;var r,s=n(0),o=(r=n(6))&&r.__esModule?r:{default:r},i=n(1),c=n(3);var a=function(e){var t,n;function r(t){var n;return(n=e.call(this)||this).users=[],n.tracks=[],n.localTracks=[],n.rtmphost="",n.signalingurl="wss://rtmpgate.cloudvdn.com/",n.mergeJobs=[],n.mergingJobs=[],t&&t.server&&(n.signalingurl=t.server),n}n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var s=r.prototype;return s.joinRoomWithToken=function(e,t){var n=this;try{var r=(0,i.getRoomAccessFromToken)(e);this.userId=r.userId,this.roomName=r.roomName,this.appId=r.appId}catch(e){return Promise.reject(e)}return this.ws=new o.default(this.signalingurl,this.appId,e,this.userId,this.roomName,t),this.ws.on("#message",this.onMessage.bind(this)),this.ws.on("@error",this.onError.bind(this)),this.ws.on("#closed",function(){n.releaseRoom(),n.emit("disconnected")}),this.ws.init().then(function(e){return console.log("init",e),n.users=e.players||[],n.tracks=e.tracks||[],n.rtmptoken=e.rtmptoken,n.rtmphost=e.rtmphost,n.ws.on("connected",n.onConnected.bind(n)),n.ws.on("reconnecting",function(){return n.emit("reconnecting")}),e})},s.onConnected=function(e){var t=this;console.log("connected",e),this.emit("reconnected"),this.rtmptoken=e.rtmptoken,this.rtmphost=e.rtmphost;var n=e.players||[],r=(e.tracks||[]).filter((0,c.propNotEq)("playerid",this.userId)),s=(0,i.diff)(this.users,n,(0,c.prop)("playerid")),o=(0,i.diff)(this.tracks,r,(0,c.prop)("trackid"));return Promise.resolve().then(function(){return s.remove.forEach(t.handlePlayerOut,t),o.remove.length>0&&t.handleRemoveTracks({tracks:o.remove}),s.add.forEach(t.handlePlayerIn,t),o.add.length>0&&t.handleAddTracks({tracks:o.add}),!0})},s.onError=function(e){this.emit("error",e)},s.onMessage=function(e,t){switch(console.log("[onmessage] "+e+": "+JSON.stringify(t)),e){case"on-player-in":this.handlePlayerIn(t);break;case"on-player-out":this.handlePlayerOut(t);break;case"on-add-tracks":this.handleAddTracks(t);break;case"on-remove-tracks":this.handleRemoveTracks(t);break;case"on-add-local-tracks":this.handleAddLocalTracks(t);break;case"on-remove-local-tracks":this.handleRemoveLocalTracks(t);break;case"disconnect":this.emit("disconnect",t),this.leaveRoom();break;case"create-merge-job-res":this.handleCreateMergeJob(t);break;case"update-merge-tracks-res":this.handleUpdateMergeTracks(t);break;case"stop-merge-res":this.handleStopMerge(t);break;case"on-messages":this.handleOnMessages(t)}},s.handlePlayerIn=function(e){var t=this.users.indexOf(function(t){return t.playerid===e.playerid});-1!==t?this.users[t]=e:this.users.push(e),this.emit("user-join",e)},s.handlePlayerOut=function(e){this.users=this.users.filter(function(t){return t.playerid!==e.playerid}),this.emit("user-leave",e)},s.handleAddTracks=function(e){var t=this;e.tracks.forEach(function(e){var n=t.tracks.indexOf(function(t){return t.trackid===e.trackid});-1!==n?t.tracks[n]=e:t.tracks.push(e)}),this.emit("track-add",e.tracks)},s.handleRemoveTracks=function(e){this.tracks=this.tracks.filter(function(t){return!e.tracks.some(function(e){return e.trackid===t.trackid})}),this.emit("track-remove",e.tracks)},s.handleAddLocalTracks=function(e){this.localTracks=e.tracks,this.emit("local-track-add",e.tracks)},s.handleRemoveLocalTracks=function(e){this.localTracks=[],this.emit("local-track-remove",e.tracks)},s.handleCreateMergeJob=function(e){if(0===e.code){var t=this.newMergeJob;this.mergeJobs.push(t),this.newMergeJob=null,this.emit("merge-job-create",t,this.mergeJobs)}},s.handleUpdateMergeTracks=function(e){var t=(0,c.find)(this.mergeJobs,function(t){return t.rpcid===e.rpcid});0===e.code&&t&&(-1===this.mergingJobs.indexOf(t.id)&&this.mergingJobs.push(t.id),this.emit("merge-update",t,this.mergeJobs))},s.handleStopMerge=function(e){var t=(0,c.find)(this.mergeJobs,function(t){return t.rpcid===e.rpcid});0===e.code&&t&&(this.mergeJobs=this.mergeJobs.filter(function(t){return t.rpcid!==e.rpcid}),this.mergingJobs=this.mergingJobs.filter(function(e){return e!==t.id}),this.emit("merge-stop",t,this.mergeJobs))},s.handleOnMessages=function(e){this.emit("message-recv",e)},s.publish=function(){return"rtmp://"+this.rtmphost+"/?rtmptoken="+this.rtmptoken+"&playerid="+this.userId},s.subscribe=function(e){if(this.tracks&&e!==this.userId){var t=this.tracks.filter(function(t){return t.playerid===e&&t.master}).map(function(e){return e.trackid});if(0!==t.length)return"rtmp://"+this.rtmphost+"/?rtmptoken="+this.rtmptoken+"&trackid="+t.join("&trackid=")+"&playerid="+e}},s.createMergeJob=function(e,t){if(!this.newMergeJob){return this.newMergeJob=Object.assign({publishUrl:"",audioOnly:"",height:"",width:"",fps:"",kbps:"",minRate:"",maxRate:"",stretchMode:"aspectFill",watermarks:[],background:{}},t,{id:e,rpcid:(0,i.rpcid)()}),this.ws.sendCreateMergeJob(this.newMergeJob)}},s.updateMergeTracks=function(e){return this.ws.sendUpdateMergeTracks(e)},s.addMergeTracks=function(e,t){return this.updateMergeTracks({id:t,add:e})},s.removeMergeTracks=function(e,t){return this.updateMergeTracks({id:t,remove:e})},s.stopMerge=function(e){return this.ws.sendStopMerge(e)},s.sendMessage=function(e,t){return this.ws.sendSendMessage(e,t)},s.leaveRoom=function(){if(this.ws)return this.ws.send("disconnect").then(this.releaseRoom.bind(this)).catch(this.releaseRoom.bind(this))},s.releaseRoom=function(){this.removeAllListeners(),this.ws&&this.ws.close()},r}(s.EventEmitter);t.default=a},function(e,t,n){"use strict";t.__esModule=!0,t.default=t.SignalingState=void 0;var r,s=n(0),o=n(2),i=n(1),c=(r=n(8))&&r.__esModule?r:{default:r};var a={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3};t.SignalingState=a;var u=function(e){var t,n;function r(t,n,r,s,o,i){var c;return(c=e.call(this)||this).url=t,c.app=n,c.accessToken=r,c.user=s,c.room=o,c.userData=i||"",c.reconnectTimeout=1e4,c}n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var s=r.prototype;return s.init=function(){var e=this;return new Promise(function(t,n){e._state=a.CONNECTING,e.ws&&e.ws.silentClose();var r=new c.default(e.url);r.on("open",function(){console.log("socketopen"),t(e.sendAuth().then(function(t){return e._state=a.OPEN,r.off("close",n),r.on("close",e.onClose.bind(e)),e.rtmptoken=t.rtmptoken,e._state=a.OPEN,e.emit("connected",t),t}))}),r.on("close",n),r.on("message",e.onMessage.bind(e)),e.ws=r})},s.onOpen=function(e){console.log("on socket open",e),this.emit("#open",e)},s.onClose=function(e){switch(console.log("on socket close: ",e.code),Number(e.code)){case 1e3:this._state=a.CLOSED,this.emit("#closed",e);break;case 1001:case 1005:case 1006:case 1011:this.reconnect();break;case 1012:this.reconnect(5e3);break;case 1013:this.reconnect();break;case 1014:this.reconnect(5e3)}},s.onError=function(e){console.log("on socket error",e),this.emit("#error",e)},s.onMessage=function(e){var t=e.data;console.info(Date.now().toLocaleString()+" onmessage "+t);var n=t.indexOf("=");if(n>0){var r=t.substring(0,n),s=JSON.parse(t.substring(n+1));this.receiveWsMsg(r,s)}},s.receiveWsMsg=function(e,t){"ping"===e?this.handlePing():t.rpcid?this.emit("#message#"+t.rpcid,e,t):this.emit("#message",e,t)},s.send=function(e,t){if(void 0===t&&(t={}),this.ws){var n=e+"="+JSON.stringify(t);return this.ws.send(n)}},s.request=function(e,t){var n=this;return void 0===t&&(t={}),new Promise(function(r,s){t.rpcid||(t.rpcid=(0,i.rpcid)()),n.send(e,t).catch(s),console.log("send: "+e+JSON.stringify(t)),n.once("#message#"+t.rpcid,function(e,t){console.log("recv:",e,t),0===t.code?r(t):s(t)})})},s.close=function(){this.reconnectTimeoutID&&clearTimeout(this.reconnectTimeoutID),this.ws&&this.ws.close()},s.handlePing=function(){var e=this;this.send("pong",{}),this.reconnectTimeoutID&&clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=setTimeout(function(){console.log("signaling: websocket heartbeat timeout"),e.emit("timeout","signaling: websocket heartbeat timeout"),e.reconnect()},9e3)},s.reconnect=function(e){var t=this;return void 0===e&&(e=1e3),this.reconnectTimeoutID&&clearTimeout(this.reconnectTimeoutID),this._state===a.CLOSED?(this.ws.silentClose(),this.emit("#error"),Promise.resolve()):this.reconnectPromise?this.reconnectPromise:(void 0===this.reconnectTimeoutID&&(this.reconnectTimeoutID=setTimeout(function(){t._state=a.CLOSED,t.reconnectTimeoutID=void 0},this.reconnectTimeout)),this._state=a.CONNECTING,this.emit("reconnecting"),console.log("signaling: websocket reconnecting"),this.reconnectPromise=(0,i.timeout)(e).then(this.init.bind(this)).then(function(e){return t.reconnectPromise=void 0,console.log("signaling: websocket reconnected"),e}).catch(function(e){if(t.reconnectPromise=void 0,e.code){if(10001!==e.code)return t.reconnect();t._state=a.CLOSED}return console.log("signaling: websocket reconnect fail",e),t.ws.close(),t.emit("@error",e),Promise.reject(e)}),this.reconnectPromise)},s.sendAuth=function(){var e;return e=this.rtmptoken?{rtmptoken:this.rtmptoken}:{app:this.app,agent:"wechat miniprogram",roomtoken:this.accessToken,sdkversion:o.version,room:this.room,user:this.user,playerdata:this.userData},this.request("auth",e)},s.sendCreateMergeJob=function(e){return this.request("create-merge-job",e)},s.sendUpdateMergeTracks=function(e){return this.request("update-merge-tracks",e)},s.sendStopMerge=function(e){return this.request("stop-merge",{id:e})},s.sendSendMessage=function(e,t){var n={msgid:(0,i.rpcid)(),target:e,type:"normal",text:t};return this.request("send-message",n)},r}(s.EventEmitter);t.default=u},function(e,t){e.exports=require("js-base64")},function(e,t,n){"use strict";function r(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}t.__esModule=!0,t.default=void 0;var s=function(e){var t,n;function s(t){var n;return(n=e.call(this)||this).socketTask=wx.connectSocket({url:t,success:function(e){console.log("success:"+JSON.stringify(e))},fail:function(e){console.log("fail:"+JSON.stringify(e))}}),n.socketTask.onClose(n.emit.bind(r(n),"close")),n.socketTask.onError(n.emit.bind(r(n),"error")),n.socketTask.onMessage(n.emit.bind(r(n),"message")),n.socketTask.onOpen(n.emit.bind(r(n),"open")),n}n=e,(t=s).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var o=s.prototype;return o.send=function(e){var t=this;return new Promise(function(n,r){try{t.socketTask.send({data:e,success:n,fail:r})}catch(e){r(e)}})},o.close=function(){return this.socketTask.close()},o.silentClose=function(){return this.removeAllListeners(),this.socketTask.close()},s}(n(0).EventEmitter);t.default=s}]);
//# sourceMappingURL=index.js.map